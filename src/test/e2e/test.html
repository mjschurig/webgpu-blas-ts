<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebGPU BLAS E2E Tests</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-left: 4px solid #007bff;
        background: #f8f9fa;
      }
      .test-passed {
        border-left-color: #28a745;
      }
      .test-failed {
        border-left-color: #dc3545;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>WebGPU BLAS E2E Tests</h1>
      <div id="webgpu-status" class="status info">
        Checking WebGPU support...
      </div>
      <div id="test-results"></div>
    </div>

    <!-- Load the built library -->
    <script type="module">
      // Import the built WebGPU BLAS library
      import * as WebGPUBLAS from '/webgpu-blas.esm.js';

      // Test framework
      class TestRunner {
        constructor() {
          this.results = [];
          this.statusEl = document.getElementById('webgpu-status');
          this.resultsEl = document.getElementById('test-results');
        }

        async checkWebGPUSupport() {
          if (!navigator.gpu) {
            this.setStatus('error', 'WebGPU is not supported in this browser');
            return false;
          }

          try {
            const adapter = await navigator.gpu.requestAdapter();
            if (!adapter) {
              this.setStatus('error', 'No WebGPU adapter found');
              return false;
            }

            const device = await adapter.requestDevice();
            if (!device) {
              this.setStatus('error', 'Failed to get WebGPU device');
              return false;
            }

            this.setStatus(
              'success',
              `WebGPU is supported! Adapter: ${adapter.info?.vendor || 'Unknown'}`
            );
            return true;
          } catch (error) {
            this.setStatus('error', `WebGPU error: ${error.message}`);
            return false;
          }
        }

        setStatus(type, message) {
          this.statusEl.className = `status ${type}`;
          this.statusEl.textContent = message;
        }

        async runTest(name, testFn) {
          console.log(`Running test: ${name}`);
          try {
            const startTime = performance.now();
            await testFn();
            const endTime = performance.now();

            this.results.push({
              name,
              status: 'passed',
              time: endTime - startTime,
              error: null,
            });

            console.log(
              `‚úÖ ${name} passed (${(endTime - startTime).toFixed(2)}ms)`
            );
          } catch (error) {
            this.results.push({
              name,
              status: 'failed',
              time: 0,
              error: error.message,
            });

            console.error(`‚ùå ${name} failed:`, error);
          }
        }

        displayResults() {
          const passed = this.results.filter(r => r.status === 'passed').length;
          const failed = this.results.filter(r => r.status === 'failed').length;

          this.resultsEl.innerHTML = `
                    <h2>Test Results</h2>
                    <p><strong>Passed:</strong> ${passed}, <strong>Failed:</strong> ${failed}</p>
                    ${this.results
                      .map(
                        result => `
                        <div class="test-result test-${result.status}">
                            <h4>${result.name}</h4>
                            ${
                              result.status === 'passed'
                                ? `<p>‚úÖ Passed in ${result.time.toFixed(2)}ms</p>`
                                : `<p>‚ùå Failed: <code>${result.error}</code></p>`
                            }
                        </div>
                    `
                      )
                      .join('')}
                `;
        }

        // Helper function for floating point comparison
        expect(actual) {
          return {
            toBeCloseTo: (expected, precision = 2) => {
              const diff = Math.abs(actual - expected);
              const tolerance = Math.pow(10, -precision);
              if (diff >= tolerance) {
                throw new Error(
                  `Expected ${actual} to be close to ${expected} (within ${tolerance}), but difference was ${diff}`
                );
              }
            },
            toBe: expected => {
              if (actual !== expected) {
                throw new Error(`Expected ${actual} to be ${expected}`);
              }
            },
          };
        }
      }

      // Global test runner instance
      window.testRunner = new TestRunner();
      window.expect = actual => window.testRunner.expect(actual);
      window.WebGPUBLAS = WebGPUBLAS;

      // Run tests when page loads
      window.addEventListener('load', async () => {
        const runner = window.testRunner;

        // Check WebGPU support first
        const hasWebGPU = await runner.checkWebGPUSupport();
        if (!hasWebGPU) {
          runner.displayResults();
          return;
        }

        try {
          // Initialize the library
          await WebGPUBLAS.initialize();
          console.log('‚úÖ WebGPU BLAS initialized');

          // Log available functions for debugging
          console.log(
            'Available WebGPU BLAS functions:',
            Object.keys(WebGPUBLAS)
          );

          // Run SASUM tests
          await runner.runTest('SASUM - Basic positive numbers', async () => {
            const sx = new Float32Array([1, 2, 3, 4, 5]);
            const result = await WebGPUBLAS.sasum({ n: 5, sx });
            expect(result).toBeCloseTo(15.0);
          });

          // Run SAXPY tests
          await runner.runTest('SAXPY - Basic operation', async () => {
            const sx = new Float32Array([1, 2, 3, 4]);
            const sy = new Float32Array([5, 6, 7, 8]);
            await WebGPUBLAS.saxpy({ n: 4, alpha: 2.0, sx, sy });

            // Expected: y = 2*x + y = [7, 10, 13, 16]
            expect(sy[0]).toBeCloseTo(7);
            expect(sy[1]).toBeCloseTo(10);
            expect(sy[2]).toBeCloseTo(13);
            expect(sy[3]).toBeCloseTo(16);
          });

          console.log('üéâ All tests completed');
        } catch (error) {
          console.error('Test initialization failed:', error);
          runner.setStatus(
            'error',
            `Test initialization failed: ${error.message}`
          );
        }

        runner.displayResults();
      });
    </script>
  </body>
</html>
